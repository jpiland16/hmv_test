<html>
    <head>
        <title>test POST request</title>
        <script>

            function upload() {

                let el = document.getElementById("myFile");
                let files = el.files;

                const formData = new FormData();

                for (let i = 0; i < files.length; i++) {
                    formData.append('file' + i, files[i]);
                    formData.append('file' + i + 'params', "some parameters");
                }

                let token = window.localStorage.getItem("token") || undefined

                if (!token) {
                    let x = new XMLHttpRequest()
                    x.open("GET", "/api/generate-token")
                    x.onload = () => {
                        token = x.responseText
                        window.localStorage.setItem("token", token)
                        onTokenReady()
                    }
                    x.send()
                } else {
                    onTokenReady()
                }

                function onTokenReady() {
                    formData.append('token', token)

                    let x1 = new XMLHttpRequest();
                    x1.onload = () => {
                        console.log("Finished");

                        let x2 = new XMLHttpRequest();
                        x2.open('GET', "/api/scan-all-files");
                        x2.send();

                    }
                    x1.open("POST", "/api/upload-file");
                    x1.send(formData);
                }

            }

        </script>
    </head>

    <body>
        <input type="file" id="myFile" multiple/>
        <button onclick="upload()">Upload</button>
    </body>

</html>